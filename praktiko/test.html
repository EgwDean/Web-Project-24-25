<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Επεξεργασία και Αποστολή στον Server</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Ανέβασε το Αρχείο Excel, Επεξεργάσου το και Αποθήκευσέ το στον Server</h1>

    <!-- Φόρμα για την επιλογή του αρχείου Excel -->
    <input type="file" id="excelFile" accept=".xlsx" />
    <button onclick="processFile()">Επεξεργασία Excel</button>

    <script>
        function processFile() {


            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'get_praktiko.php'); // Κλήση του get_praktiko.php
            xhr.send();

            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText)['items']; // Απόκριση από το PHP αρχείο

                        // Αν υπάρχει δεδομένο (μια γραμμή)
                        if (data.length > 0) {
                            // Αποθήκευση των τιμών σε μεταβλητές
                            var diploma_id = data[0]['diploma_id'];
                            var supervisor = data[0]['supervisor_full_name'];
                            var member1 = data[0]['member1_full_name'];
                            var member2 = data[0]['member2_full_name'];
                            var student_name = data[0]['student_full_name'];
                            var am = data[0]['am'];			
                            var examination_date = data[0]['examination_date'];
                            var examination_room = data[0]['examination_room'];
                            var grade1 = data[0]['grade_member1'];
                            var grade2 = data[0]['grade_member2'];
                            var grade3 = data[0]['grade_member3'];
                            var final_grade = data[0]['final_grade'];
                            var diploma_title = data[0]['diploma_title'];
                            var p_number = data[0]['protocol_number'];

		// Λήψη του αρχείου
            var file = document.getElementById('excelFile').files[0];
            
            if (file) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    var data = e.target.result;
                    
                    // Ανάγνωση του Excel αρχείου
                    var workbook = XLSX.read(data, {type: 'binary'});
                    
                    // Επιλογή του πρώτου φύλλου εργασίας
                    var sheet = workbook.Sheets[workbook.SheetNames[0]];

                    // Γράψιμο της τιμής "10" στο κελί A1
//MOST IMPORTANT    
//     		    sheet["A1"] = { v: examination_date };  // Θέτουμε την τιμή examination_date στο κελί A1

      		    sheet["C3"] = { v: student_name };  

      		    sheet["J3"] = { v: am };

      		    sheet["E4"] = { v: diploma_title }; 

      		    sheet["A6"] = { v: supervisor }; 

      		    sheet["A7"] = { v: member1 }; 

      		    sheet["A8"] = { v: member2 }; 

      		    sheet["C10"] = { v: examination_room }; 

      		    sheet["C11"] = { v: examination_date }; 

      		    sheet["A15"] = { v: supervisor }; 

      		    sheet["A16"] = { v: member1 }; 

      		    sheet["A17"] = { v: member2 }; 

      		    sheet["F19"] = { v: p_number }; 

      		    sheet["G22"] = { v: student_name }; 

      		    sheet["B29"] = { v: grade1 }; 

      		    sheet["B30"] = { v: grade2 }; 

      		    sheet["B31"] = { v: grade3 }; 

      		    sheet["B35"] = { v: final_grade }; 

      		    sheet["A29"] = { v: supervisor }; 

      		    sheet["A30"] = { v: member1 }; 

      		    sheet["A31"] = { v: member2 }; 

      		    sheet["G38"] = { v: student_name }; 

      		    sheet["A46"] = { v: supervisor }; 

      		    sheet["A47"] = { v: member1 }; 

      		    sheet["A48"] = { v: member2 }; 

                    // Σώσιμο του νέου Excel αρχείου
                    var wbout = XLSX.write(workbook, {bookType: 'xlsx', type: 'binary'});

                    // Μετατροπή σε ArrayBuffer για την αποστολή
                    var blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});

                    // Δημιουργία ενός νέου FormData για το upload
                    var formData = new FormData();
			formData.append("file", blob, file.name);


                    // Αποστολή του αρχείου στον server μέσω AJAX
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "upload.php", true);
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            alert('Το αρχείο ανέβηκε επιτυχώς στον server!');
                        } else {
                            alert('Σφάλμα κατά το ανέβασμα του αρχείου.');
                        }
                    };
                    xhr.send(formData);
                };

                reader.readAsBinaryString(file);
            } else {
                alert("Παρακαλώ επιλέξτε ένα αρχείο Excel πρώτα.");
            }
        }

        // Συνάρτηση για μετατροπή σε ArrayBuffer
        function s2ab(s) {
            var buf = new ArrayBuffer(s.length);
            var view = new Uint8Array(buf);
            for (var i = 0; i < s.length; i++) {
                view[i] = s.charCodeAt(i) & 0xFF;
            }
            return buf;
        }

                        }
                    } 
                }
            }

            
    </script>
</body>
</html>

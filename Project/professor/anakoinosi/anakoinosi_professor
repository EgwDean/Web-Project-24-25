<?php
header("Content-Type: application/json");

$servername = "localhost";
$username = "root";
$password = "556782340";
$dbname = "diplomatiki_support";


$conn = new mysqli($servername, $username, $password, $dbname);

if ($conn->connect_error) {
    echo json_encode(["error" => "Connection failed: " . $conn->connect_error]);
    exit;
}


$id = isset($_GET['id']) ? intval($_GET['id']) : 0;
if ($id <= 0) {
    echo json_encode(["error" => "Invalid or missing ID."]);
    exit;
}


$sql = "SELECT CONCAT(student.name, ' ', student.surname) AS student_full_name, 
               student_number AS AM, 
               id_diplomatikis AS id, 
               title, 
               exam_date, 
               exam_room, 
               CONCAT(professor.name, ' ', professor.surname) AS professor_full_name,
               grade1, 
               grade2, 
               grade3, 
               final_grade
        FROM eksetasi_diplomatikis 
        INNER JOIN diplomatiki ON eksetasi_diplomatikis.id_diplomatikis = diplomatiki.id_diplomatiki
        INNER JOIN student ON eksetasi_diplomatikis.email_st = student.email_student
        INNER JOIN professor ON diplomatiki.email_prof = professor.email_professor
        WHERE id_diplomatikis = $id
        ORDER BY exam_date ASC";


$result = $conn->query($sql);

// Check for SQL errors
if (!$result) {
    echo json_encode(["error" => "SQL error: " . $conn->error]);
    exit;
}

// Fetch the results
$data = [];
if ($result->num_rows > 0) {
    while ($row = $result->fetch_assoc()) {
        $data[] = $row;
    }
} else {
    echo json_encode(["message" => "No data found for the given ID."]);
    exit;
}

// Output the data as JSON
echo json_encode($data);

// Close the database connection
$conn->close();
?>